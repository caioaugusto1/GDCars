@model VendaDeAutomoveis.Models.CadastrarVendaViewModel

<title>Cadastrar - Venda</title>

@{
    ViewBag.Title = "Cadastrar - Venda";
    //Html.RenderPartial("_partial/_cabecalho_principal");
}

<div class="dashboard-wrapper">
    <div class="page-title clearfix">
        <h2>
            Venda
            <small>
                <ul>
                    <li>Home</li>
                    <li>/</li>
                    <li>Venda</li>
                    <li>/</li>
                    <li>Cadastrar</li>
                </ul>
            </small>
        </h2>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="widget no-margin">
                <div class="widget-header">
                    <div class="title">
                        <span class="fs1" aria-hidden="true" data-icon="&#xe075;"></span> Cadastrar
                    </div>
                </div>
                <div class="widget-body">
                    <div class="row">
                        <div class="col-md-2 col-sm-3">
                            <div class="thumbnail">
                                AQUI VAI UMA IMAGEM
                                @*<img src="~/Content/bootstrap/img/ccn.png" />*@
                            </div>
                        </div>
                        <div class="col-md-10 col-sm-9">

                            @using (Html.BeginForm("Create", "Venda", FormMethod.Post, new { @class = "form-horizontal", @id = "form" }))
                            {
                                @Html.AntiForgeryToken()
                                <div class="form-group">
                                    <div class="col-md-10">
                                        @Html.LabelFor(m => m.IdCliente, "Nome do Cliente*")
                                        @Html.DropDownListFor(m => m.IdCliente,
                                            new SelectList(Model.Clientes, "Id", "Nome"), "Nome do Cliente",
                                            new { @class = "form-control" })
                                        @Html.ValidationMessageFor(m => m.IdCliente)
                                    </div>
                                </div>


                                <div class="form-group">
                                    <div class="col-md-10">
                                        @Html.LabelFor(m => m.IdVeiculo, "Modelo do Veículo*")
                                        @Html.DropDownListFor(m => m.IdVeiculo,
                                            new SelectList(Model.Veiculos, "Id", "Modelo"), "Modelo do Veículo",
                                            new { @class = "form-control" })
                                        @Html.ValidationMessageFor(m => m.IdVeiculo)
                                    </div>
                                </div>

                                Html.RenderPartial("_partial/_CreateEdit", Model);

                                Html.RenderPartial("~/Views/Shared/_partial/_btn_submit_cadastrar.cshtml");
                            }

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/Content/bootstrap/js/bootstrap.js"></script>

<script>
    $(function () {

        $('#parcialEndereco').hide();

    @if (ViewBag.ExibirCampo != null) {
        @:pegarValorEndereco();
                }
    });

    $('#IdVeiculo').change(function () {
        obterValorVeiculo();
    });

    $('#Tipo_Entrega').change(function () {
        pegarValorEndereco();
    });

    $('#IdCliente').change(function () {
        pegarValorEndereco();
        obterInformacoesCliente();
    });

    $("#btnSalvarEndereco").click(function () {
        $('#modalConfirme').modal();
    });

    $('#btnSalvarModal').click(function () {
        AtualizarEndereco();
    });

    function obterValorVeiculo() {
        $.ajax({
            url: '@Url.Action("ObterValorVeiculo")',
            type: "post",
            dataType: "html",
            data:
            {
                idVeiculo: $("#IdVeiculo").val()
            },
            success: function (data) {
                $("#Valor").val(data);
                $("#Valor").text(data);
            }
        });
    }

    function pegarValorEndereco() {

        if ($("#IdCliente").val() != '' && $("#Tipo_Entrega").val() == 1) {
            $('#parcialEndereco').hide();
        }

        if ($("#IdCliente").val() != '' && $("#Tipo_Entrega").val() == 0) {
            $('#parcialEndereco').show();

            $.ajax({
                url: '@Url.Action("ObterEnderecoCliente")',
                type: "post",
                dataType: "html",
                data: { IdCliente: $("#IdCliente").val() },
                success: function (data) {
                    $('#parcialEndereco').html(data);
                    //$("#atualizar").click(function () {

                    //    AtualizarEndereco()
                    //});
                }
            });
        }
    }


    function AtualizarEndereco() {

        $.ajax({
            url: '@Url.Action("AtualizarEnderecos")',
            type: "post",
            dataType: "html",
            data: {
                IdCliente: $("#IdCliente").val(),
                Endereco: $("#EnderecoNome").val(),
                Bairro: $("#Bairro").val(),
                NumeroDaCasa: $("#Numero").val(),
                CEP: $("#CEP").val(),
                Cidade: $("#Cidade").val(),
                Estado: $("#Estado").val(),
                Complemento: $("#Complemento").val()
            },
            success: function (data) {
                $('#success').modal();
            }
        });
    }

    function obterInformacoesCliente() {

        $.ajax({
            url: '@Url.Action("ObterInformacoesBasicasCliente")', //Metodo da minha controller
            type: "POST",
            dataType: "html",
            data: { IdCliente: $("#IdCliente").val() },
            success: function (data) {

                $('#PegarFormaDePagamento').html(data.FormasDePagamentos); //div para renderizar
                $('#_PerformancesDisponiveisCliente').html(data.Performances);
            }
        });
    }

    $('#btnCadastrar').click(function () {
        var isValid = validForm();

        if (isValid == false) {
            saveLead();
        }
        else {
            $('#form').submit();
        }
    });

    var msgs = [];
    function validForm() {
        msgs = [];
        var campo;
        var isValid = true;

         campo = $("#IdCliente option:selected").val();
        if (!campo && campo.length <= 0) {
            isValid = false;
            $('#IdCliente').css({ "background-color": "#f8dbdb", "border-color": "#e77776" });
            msgs.push("É necessário preencha o cliente.");
        } else {
            $('#IdCliente').css({ "background-color": "#fff", "border-color": "#ccc" });
        }

        campo = $("#IdVeiculo option:selected").val();
        if (!campo && campo.length <= 0) {
            isValid = false;
            $('#IdVeiculo').css({ "background-color": "#f8dbdb", "border-color": "#e77776" });
            msgs.push("É necessário preencha o cliente.");
        } else {
            $('#IdVeiculo').css({ "background-color": "#fff", "border-color": "#ccc" });
        }

        campo = $("#Valor").val();
        if (!campo && campo.length <= 0) {
            isValid = false;
            $('#Valor').css({ "background-color": "#f8dbdb", "border-color": "#e77776" });
            msgs.push("É necessário preencha o cliente.");
        } else {
            $('#IdCliente').css({ "background-color": "#fff", "border-color": "#ccc" });
        }

        campo = $("#idCustom option:selected").val();
        if (!campo && campo.length <= 0) {
            isValid = false;
            $('#idCustom').css({ "background-color": "#f8dbdb", "border-color": "#e77776" });
            msgs.push("É necessário preencha o cliente.");
        } else {
            $('#idCustom').css({ "background-color": "#fff", "border-color": "#ccc" });
        }

        campo = $("#Tipo_Entrega option:selected").text();
        if (!campo && campo.length <= 0) {
            isValid = false;
            $('#Tipo_Entrega').css({ "background-color": "#f8dbdb", "border-color": "#e77776" });
            msgs.push("É necessário preencha o cliente.");
        } else {
            $('#Tipo_Entrega').css({ "background-color": "#fff", "border-color": "#ccc" });
        }

        campo = $("#Status option:selected").text();
        if (!campo && campo.length <= 0) {
            isValid = false;
            $('#Status').css({ "background-color": "#f8dbdb", "border-color": "#e77776" });
            msgs.push("É necessário preencha o cliente.");
        } else {
            $('#Status').css({ "background-color": "#fff", "border-color": "#ccc" });
        }

        //campo observação
        campo = $('#wysiwyg').val();
        if (!campo && campo.length <= 0) {
            isValid = false;
            $('#wysiwyg').css({ "background-color": "#f8dbdb", "border-color": "#e77776" });
            msgs.push("É necessário preencher o Modelo do veículo.");
        } else {
            $('#wysiwyg').css({ "background-color": "#fff", "border-color": "#ccc" });
        }

        return isValid;
    }

    function saveLead() {
        var form = document.forms[0];
        if (validForm()) {
            form.submit();
        }
        else {
            var novoHTML = "";
            for (var i = 0; i < msgs.length; i++) {
                var msg = msgs[i];
                novoHTML += msg + "<br />";
            }
            $('#modalError .modal-body').html(novoHTML);
            $('#modalError').modal('show');
            document.body.scrollTop = document.documentElement.scrollTop = 0;
        }
    }


</script>